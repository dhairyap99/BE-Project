{% extends "main/base.html" %}

{% block title %}Account Registration{% endblock %}
{% load crispy_forms_tags %}

{% block content %}
    <form method="POST" action="../register_submit" class="form-group" enctype="multipart/form-data">
        {% csrf_token %}
        {{register_form1|crispy}}
        
        {{register_form2|crispy}}

        <input type="hidden" name="otp1">
        <input type="password" name="otp2" id="otp2" style="display:none" placeholder="Enter OTP here">
        <input type="button" class="btn" value="Verify Email" onclick="sendEmail()" id="otp_button"/>

        <p>Already have a HastAkshar account? <a href="/login/">Login instead</a>!</p>
        <button type="submit" class="btn btn-success" style="display:none" id="submit">Register</button>     
    </form>
  
  <script type="text/javascript">
   

    function sendEmail() { 
        console.log("sendEmail")
        var pwd1 = $("#id_password1").val()
        var pwd2 = $("#id_password2").val()
        if (pwd1==pwd2){
            if (pwd1!="" && pwd2!=""){
            var mail = $("#id_email").val()

            $("#otp2").css("display","block");
            $("#submit").css("display","block");
            $("#otp_button").css("display","none");

            var num = 0
            for (i = 0; i < 5; i++) {
                num = num*10;
                digit = Math.floor(Math.random() * 10);
                num = num + digit
            }
            
            console.log(num)
            
            var str = num.toString()

            $("#otp1").val = str
            var msg =  "Dear user,\nYour OTP for Hastakshar Account Registration is: " + str + ".\nKindly DO NOT share this One-Time-Password with anyone!\n\n--\nWarm Regards\nSupport Team at Hastakshar"
            
            Email.send({ 
                Host: "smtp.gmail.com", 
                Username: "{{from_mail}}", 
                Password: "{{password}}", 
                To: mail, 
                From: "{{from_mail}}", 
                Subject: "OTP for Hastakshar Account Registration", 
                Body: msg
            }) 
            .then(function (message) { 
            alert("OTP sent successfully") 
            }); 
            }else{
                $("#id_password1").val("")
                $("#id_password2").val("") 
                alert ("Passwords can't be blank")
            }
        }else{
            $("#id_password1").val("")
            $("#id_password2").val("")
            alert ("Passwords don't match")
        }
    }
  </script> 
{% endblock %}